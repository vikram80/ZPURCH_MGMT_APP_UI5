sap.ui.define(["sap/ui/core/mvc/Controller",
	"sap/ui/model/json/JSONModel",
	"sap/m/MessageBox",
	"../model/formatter",
	"sap/m/Token"
], function (Controller, JSONModel, MessageBox, formatter, Token) {
	"use strict";
	return Controller.extend("zpurch_mgmt_app.ZPURCH_MGMT_APP.controller.Search", {
		formatter: formatter,
		onInit: function () {
			var oThis = this;
			var oComponent = oThis.getOwnerComponent();
			oThis._oResourceBundle = oComponent.getModel("i18n").getResourceBundle();
			oThis.oRouter = sap.ui.core.UIComponent.getRouterFor(oThis);
//Test1
			// sap.ui.getCore().setModel(oF4Model, "F4Model");

			// To add token on PO Number Input
			var oMultiInput = oThis.getView().byId("PO");
			//******* MultiInput - add asynchronous validator
			oMultiInput.addValidator(function (args) {
				var oToken = new Token({
					key: args.text,
					text: args.text
				});
				args.asyncCallback(oToken);
			});

			var oPOTModel = oThis.getOwnerComponent().getModel("POModel");
			var POTShOutput = new JSONModel();

			oPOTModel.read("/pOtypeSHSet", {
				urlParameters: {
					"$filter": ""

				},
				success: function (oData, response) {
					// Mapping Plant - Description in Json Model

					for (var i = 0; i < oData.results.length; i++) {
						oData.results[i].BsartTxt = oData.results[i].Bsart +
							" - " + oData.results[i].BsartTxt;
					}
					POTShOutput.setData(oData);

					oThis.getView().byId("idPOtypeCB").setModel(POTShOutput, "POTShOutput");

				},
				error: function (oError) {
					oThis.oErrorwrap(oError);
				}
			});

		},

		handleDataChange: function (oEvent) {
			// Validate PO Number field token length
			var oThis = this;
			var oView = oThis.getView();
			var msgTextError2 = oThis._oResourceBundle.getText("MaxTokenlimit");
			var bCompact = !!this.getView().$().closest(".sapUiSizeCompact").length;
			if (oView.byId("PO").getTokens().length > oView.byId("PO").getMaxTokens()) {
				MessageBox.error(
					msgTextError2, {
						styleClass: bCompact ? "sapUiSizeCompact" : ""
					}
				);

				oView.byId("PO").removeAllTokens();
				// Highligting the Material filed if its empty
				oThis.getView().byId("PO").focus();
				oThis.getView().byId("PO").setValueState("Error");
				oThis.getView().byId("PO").setValueStateText("Max 5 inputs allowed");

			} else {
				oThis.getView().byId("PO").focus();
				oThis.getView().byId("PO").setValueState("None");
				oThis.getView().byId("PO").setValueStateText("None");
				// Do Nothing
			}
		},
		/**
		 *@memberOf zpurch_mgmt_app.ZPURCH_MGMT_APP.controller.Search
		 */
		navBackFLP: function (oEvent) {
			//This code was generated by the layout editor.
			var oCrossAppNavigator = sap.ushell.Container.getService("CrossApplicationNavigation");
			// Navigate back to FLP home
			oCrossAppNavigator.toExternal({
				target: {
					shellHash: "#Shell-home"
				}
			});
		},

		onPOValueHelpRequest: function (oEvent) {

			if (!this._dialog) {
				this._dialog = sap.ui.xmlfragment(this.getView().getId(), "zpurch_mgmt_app.ZPURCH_MGMT_APP.view.fragments.POValueHelp", this);
				this.getView().addDependent(this._dialog);

			}
			// open dialog
			jQuery.sap.syncStyleClass("sapUiSizeCompact", this.getView(), this._dialog);
			this._dialog.open();
			// this.getView().byId("ValuehelpTabPO").getModel("POShOutput").refresh();
			this.getView().byId("idShPOno").setValue("");
			this.getView().byId("idShPOType").setValue("");
			// this._dialog.close();
			// this._dialog.destroy();
		},

		onSearchPO: function (oEvent) {
			var oThis = this;
			var oView = oThis.getView();
			var outPutTable = this.getView().byId("ValuehelpTabPO");
			var inpPO = oView.byId("idShPOno").getValue();
			// var inpPODate = oView.byId("idShCrtDt").getValue();
			// if (inpPODate){
			// var temp = inpPODate.split("/");
			// inpPODate = temp[2] + "-" + temp[0] + "-" + temp[1] + "T00:00:00";
			// }
			// var inpPODate = "2019-08-22T00:00:00";
			var inpPOType = oView.byId("idShPOType").getValue();

			// Call Odata model
			var oPOModel = oThis.getOwnerComponent().getModel("POModel");
			var POShOutput = new JSONModel();

			oPOModel.read("/POSearchSet", {
				urlParameters: {
					// 	"$filter": "Ebeln eq '" + inpPO + "' and Bsart eq '" + inpPOType + "' and Aedat eq datetime'" + inpPODate + "'"
					"$filter": "Ebeln eq '" + inpPO + "' and Bsart eq '" + inpPOType + "'"

				},
				success: function (oData, response) {
					oThis.getView().byId("ValuehelpTabPO").setVisible(true);
					// oThis.getView().byId("searchbtn2").setVisible(false);
					// oThis.getView().byId("idsearchBarF4").setVisible(true);
					oThis.getView().byId("okbtn2").setVisible(true);
					POShOutput.setData(oData);
					// masterOutput.setSizeLimit(oData.results[0].ValueHelpOutSet.results.length);
					outPutTable.setModel(POShOutput, "POShOutput");
					if (oData.results.length) {
						var iTotalItems = oData.results.length;
						oThis.byId("idSearchResultTxt").setText(oThis._oResourceBundle.getText("SearchResultCount", [iTotalItems]));
					}

				},
				error: function (oError) {
					oThis.oErrorwrap(oError);
				}
			});

		},
		onSelectPO: function (oEvent) {
			var oView = this.getView();
			var aContexts = this.getView().byId("ValuehelpTabPO").getSelectedContexts();

			for (var i = 0; i < aContexts.length; i++) {
				var sPath = aContexts[i].getPath();
				var value = oView.byId("ValuehelpTabPO").getModel("POShOutput").getProperty(sPath + "/Ebeln");
				var token = new Token({
					key: value,
					text: value
				});
				oView.byId("PO").addToken(token);
			}

			// this.getView().byId("F4PODialog").close();
			// this.getView().byId("F4PODialog").destroy();
			// oView.byId("ValuehelpTabPO").getModel("POShOutput").refresh(true);
			this.getView().byId("ValuehelpTabPO").getModel("POShOutput").setData([]);
			oView.byId("idShPOno").setValue("");
			oView.byId("idShPOType").setValue("");
			this._dialog.close();
			// this._dialog.destroy();
		},

		onResetPO: function (oEvent) {
			var oView = this.getView();
			oView.byId("PO").removeAllTokens();
			oView.byId("POSearchFld").setValue("");
			oView.byId("SearchPODateRange").setValue("");
			oView.byId("idPOtypeCB").setSelectedKeys([]);
			oView.byId("messPage").setVisible(true);
			oView.byId("po_table").getModel("POSearchOutput").refresh(true);
			oView.byId("po_table").setVisible(false);
		},

		onCancelPO: function (oEvent) {
			// this.onResetPODialog(oEvent);
			// this.getView().byId("F4PODialog").close();
			// this.getView().byId("ValuehelpTabPO").getModel("POShOutput").refresh();
			this._dialog.close();
			// this._dialog.destroy();

			// this.getView().byId("F4PODialog").destroy();
		},

		onResetPODialog: function (oEvent) {
			this.getView().byId("ValuehelpTabPO").getModel("POShOutput").setData([]);
		},

		onSearchPO1: function (oEvent) {
			var oThis = this;
			var poNo = "";
			var poType = "";
			var startDate = "";
			var endDate = "";
			var oView = oThis.getView();
			var outPutTable = this.getView().byId("po_table");

			//PO NUmber
			if (oView.byId("PO").getTokens().length > 0) {
				for (var i = 0; i < oView.byId("PO").getTokens().length; i++) {
					if (i === 0) {
						poNo = oView.byId("PO").getTokens()[0].getKey();
					} else {
						poNo = poNo + "|" + oView.byId("PO").getTokens()[i].getKey();
					}
				}
			}

			//PO Type
			if (oView.byId("idPOtypeCB").getSelectedItems().length > 0) {
				for (i = 0; i < oView.byId("idPOtypeCB").getSelectedItems().length; i++) {
					if (i === 0) {
						poType = oView.byId("idPOtypeCB").getSelectedItems()[0].getKey();
					} else {
						poType = poType + "|" + oView.byId("idPOtypeCB").getSelectedItems()[i].getKey();
					}
				}
			}

			// PO Date range
			var poDate = oView.byId("SearchPODateRange").getDateValue();
			if (poDate !== "") {
				//delDate=delDate+"T00:00:00";
				// var startdate1=new Date(oView.byId("SearchPODateRange").getDateValue().getTime()+(24 * 60 * 60 * 1000));
				startDate = formatter.dateRangeValueFormat(poDate);
				startDate = startDate + "T00:00:00";

				poDate = oView.byId("SearchPODateRange").getSecondDateValue();
				endDate = formatter.dateRangeValueFormat(poDate);
				endDate = endDate + "T00:00:00";
			}
			// var inpPOType = oView.byId("idShPOType").getValue();

			// Call Odata model
			var oPOModel = oThis.getOwnerComponent().getModel("POModel");
			var POSearchOutput = new JSONModel();

			oPOModel.read("/poHeadSet", {
				urlParameters: {
					"$filter": "Ebeln eq '" + poNo + "' and Bsart eq '" + poType + "' and AedatFr eq datetime'" + startDate +
						"' and AedatTo eq datetime'" + endDate + "'"
						// "$filter": "Ebeln eq '" + inpPO + "' and Bsart eq '" + inpPOType + "'"

				},
				success: function (oData, response) {
					POSearchOutput.setData(oData);
					oView.byId("po_table").setModel(POSearchOutput, "POSearchOutput");
					//oView.byId("EquipReceiptTable").getModel("oSearchModel").refresh(true);
					var itemcount = oData.results.length;
					// oThis.getOwnerComponent().getModel("POSearchOutput").getData().results.length;
					oView.byId("panelTitleId").setText(oThis._oResourceBundle.getText("POCount", [itemcount]));
					oView.byId("messPage").setVisible(false);
					oView.byId("po_table").setVisible(true);
					// oThis.getView().byId("okbtn2").setVisible(true);
					// if (oData.results.length) {
					// 	var iTotalItems = oData.results.length;
					// 	oThis.byId("idSearchResultTxt").setText(oThis._oResourceBundle.getText("SearchResultCount", [iTotalItems]));
					// }

				},
				error: function (oError) {
					oThis.oErrorwrap(oError);

				}
			});

		},

		oErrorwrap: function (oError) {
			// Handle Time out Error (Error Code = 504), 
			var bCompact = !!this.getView().$().closest(".sapUiSizeCompact").length;
			var oThis = this;

			if (oError.statusCode === 504) {

				MessageBox.error(
					oError.statusText, {
						styleClass: bCompact ? "sapUiSizeCompact" : ""
					}
				);

			} else if (oError.statusCode === 500) {
				// Handle Internal Server Error
				MessageBox.error(
					$(oError.responseText).find('message').first().text(), {
						styleClass: bCompact ? "sapUiSizeCompact" : ""
					}
				);
			} else {

				var parsedError = JSON.parse(oError.responseText);

				/* Constructing Error Message Json to display in message box */

				// Coping Error Details in Error Full Json
				var errFullJson = parsedError.error.innererror.errordetails;

				if (errFullJson.length === 0) {
					errFullJson = parsedError.error.message.value;
				}
				// Filtering Error Messages alone in ErrorJson

				var errorJson = [];
				var errorData = {};

				var exceptionText = oThis._oResourceBundle.getText("exceptionRaised");
				for (var e = 0; e < errFullJson.length; e++) {

					// If Severity is Error -> Moving Error Json to display in Message Dialog

					if (errFullJson[e].severity === "error" && errFullJson[e].message !== exceptionText) {
						errorData = {
							"message": errFullJson[e].message
						};

						errorJson.push(errorData);
					}

				}

				var oView = oThis.getView();
				var errorModel = oThis.getOwnerComponent().getModel("errorModel");
				errorModel.setData(errorJson);
				oThis.oErrDialog = oThis.getOwnerComponent().errorListDialog;

				if (!oThis.oErrDialog) {
					// create dialog via fragment for error logs
					oThis.oErrDialog = sap.ui.xmlfragment(oThis.getView().getId(),
						"zpurch_mgmt_app.ZPURCH_MGMT_APP.view.fragments.ErrorMessageDialog",
						oThis);
				}
				oView.addDependent(oThis.oErrDialog, oThis);
				oThis.oErrDialog.open();
				oThis.oErrDialog.addStyleClass(oThis.getContentDensityClass());

			}

		},
		handleSearch: function (oEvent) {

		},

		handleConfirm: function (oEvent) {

		},
		/**
		 *@memberOf zpurch_mgmt_app.ZPURCH_MGMT_APP.controller.Search
		 */
		onSearch: function (oEvt) {
			//This code was generated by the layout editor.
			// add filter for search
			var oThis = this;
			var searchString;
			if (oEvt) {
				searchString = oEvt.getSource().getValue();
			} else {
				searchString = "";
			}

			var filters = [];
			// Adding filter to binding list item
			if (searchString) {
				filters = [new sap.ui.model.Filter([new sap.ui.model.Filter("Ebeln", sap.ui.model.FilterOperator.Contains, searchString),
					new sap.ui.model.Filter("Bsart", sap.ui.model.FilterOperator.Contains, searchString)
				])];
			}

			// update list binding
			oThis.getView().byId("po_table").getBinding("items").filter(filters);
			this.getOwnerComponent().getModel("POSearchOutput").refresh(true);

		},

		handleOkDialogError: function () {
			var oThis = this;
			if (oThis.oErrDialog) {
				oThis.oErrDialog.close();
			}
		},
		/**
		 *@memberOf zpurch_mgmt_app.ZPURCH_MGMT_APP.controller.Search
		 */
		onNavDetail: function (oEvent) {
			//This code was generated by the layout editor.
			var oThis = this;
			var a = oEvent.getSource()["oBindingContexts"].POSearchOutput.sPath.split("/");
			var Ebeln = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Ebeln;
			var Bsart = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Bsart;
			//Fields that needs to be passed to the detail screen
			var Loekz = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Loekz;
			var Aedat = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].AedatFr;
			var Ernam = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Ernam;
			var Ekorg = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Ekorg;
			var Lifnr = this.getView().byId("po_table").getModel("POSearchOutput").getData().results[(a[2])].Lifnr;
		    
			var oPOModel = oThis.getOwnerComponent().getModel("POModel"); //oData Model
			//	var POTShOutput = new JSONModel();
			oPOModel.read("/poHeadSet", {
				urlParameters: {
					"$filter": "Ebeln eq '" + Ebeln + "'",
					"$expand": "headTolineNav"
				},
				success: function (oData, response) {
					/*eslint no-console: "error"*/
					oData.results[0].Bsart = Bsart;
					oData.results[0].Loekz = Loekz;
					oData.results[0].AedatFr = Aedat;
					oData.results[0].Ernam = Ernam;
					oData.results[0].Ekorg = Ekorg;
					oData.results[0].Lifnr = Lifnr;
					// oThis.getOwnerComponent().getModel("oDetailModel").setData(oData.results[0]);
//
	//var oView = oThis.getView();
				var oDetailModel = oThis.getOwnerComponent().getModel("oDetailModel");
				oDetailModel.setData(oData.results[0]);
				
				oThis.oRouter.navTo("Detail");
			

//
				},
				error: function (oError) {
						oThis.oErrorwrap(oError);
					}
					//oThis.oRouter.navTo("Detail");
			});
		}

	});
});